<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasExpress - Repartidor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="css/styles.css"> <!-- Base styles -->
    <link rel="stylesheet" href="css/repartidor.css">
</head>
<body>

    <div class="delivery-layout">
        
        <header class="delivery-header">
            <div class="d-flex align-items-center gap-2">
                <span style="font-size: 1.5rem;">ğŸ›µ</span>
                <div>
                    <h5 class="m-0">Hola, Juan</h5>
                    <small class="text-white-50">En turno</small>
                </div>
            </div>
            <div class="delivery-status-toggle">
                <span>Disponible</span>
                <label class="switch">
                    <input type="checkbox" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </header>

        <!-- HU014: Ver pedidos -->
        <main id="orders-list">
            <h6 class="p-3 text-muted text-uppercase fw-bold m-0" style="font-size: 0.8rem;">Pedidos Asignados (2)</h6>

            <!-- Order 1 -->
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">#ORD-002</span>
                    <span class="order-time">Hace 15 min</span>
                </div>
                <div class="order-body">
                    <div class="customer-info">
                        <div class="customer-name">Ana LÃ³pez</div>
                        <div class="customer-address">ğŸ“ Collao 456, ConcepciÃ³n</div>
                        <div class="mt-2 text-muted small">1x Gas 15kg â€¢ $19.000 â€¢ Efectivo</div>
                    </div>
                    
                    <div class="alert alert-info py-2 px-3 small mb-0">
                        ğŸ“ Nota: Tocar timbre fuerte, reja negra.
                    </div>
                </div>
                <!-- HU015 & HU016 -->
                <div class="order-actions">
                    <button class="btn-action btn-map" onclick="openMap([-36.8250, -73.0200], 'Collao 456, ConcepciÃ³n')">
                        ğŸ—ºï¸ Ver Ruta
                    </button>
                    <button class="btn-action btn-status" onclick="updateStatus(this)">
                        ğŸš€ En Camino
                    </button>
                </div>
            </div>

            <!-- Order 2 -->
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">#ORD-005</span>
                    <span class="order-time">Hace 30 min</span>
                </div>
                <div class="order-body">
                    <div class="customer-info">
                        <div class="customer-name">Pedro Soto</div>
                        <div class="customer-address">ğŸ“ Av. Pedro de Valdivia 1200, ConcepciÃ³n</div>
                        <div class="mt-2 text-muted small">2x Gas 45kg â€¢ $116.000 â€¢ Transferencia</div>
                    </div>
                </div>
                <div class="order-actions">
                    <button class="btn-action btn-map" onclick="openMap([-36.8350, -73.0600], 'Av. Pedro de Valdivia 1200')">
                        ğŸ—ºï¸ Ver Ruta
                    </button>
                    <button class="btn-action btn-status" style="background-color: #f1f5f9; color: #64748b;">
                        â³ Pendiente
                    </button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="delivery-nav">
            <a href="#" class="nav-item active">
                <span>ğŸ“¦</span>
                <span>Pedidos</span>
            </a>
            <a href="#" class="nav-item">
                <span>ğŸ’°</span>
                <span>Ganancias</span>
            </a>
            <a href="#" class="nav-item">
                <span>ğŸ‘¤</span>
                <span>Perfil</span>
            </a>
        </nav>

    </div>

    <!-- HU016: Ver ruta del pedido (Modal) -->
    <div id="mapModal" class="map-modal">
        <div class="modal-header">
            <h5 class="m-0" id="mapTitle">Ruta de Entrega</h5>
            <button class="btn-close" onclick="closeMap()"></button>
        </div>
        <div id="deliveryMap" class="modal-map-container"></div>
        <div class="p-3 bg-white border-top">
            <button class="btn btn-primary w-100 py-3 fw-bold" onclick="window.open('https://www.google.com/maps', '_blank')">
                ğŸ“ Abrir en Google Maps
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        let map = null;

        function openMap(coords, address) {
            document.getElementById('mapModal').classList.add('open');
            document.getElementById('mapTitle').innerText = address;

            if (!map) {
                map = L.map('deliveryMap');
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
            }

            // Center map on delivery location
            map.setView(coords, 15);
            
            // Clear previous markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add marker for delivery
            L.marker(coords).addTo(map)
                .bindPopup("<b>Entrega aquÃ­</b><br>" + address)
                .openPopup();
                
            // Simulate current location (center of Concepcion)
            L.marker([-36.8201, -73.0444], {
                icon: L.divIcon({
                    className: 'courier-icon',
                    html: 'ğŸ›µ',
                    iconSize: [30, 30]
                })
            }).addTo(map);

            setTimeout(() => { map.invalidateSize(); }, 100);
        }

        function closeMap() {
            document.getElementById('mapModal').classList.remove('open');
        }

        function updateStatus(btn) {
            if (btn.innerText.includes('En Camino')) {
                btn.innerText = 'âœ… Entregado';
                btn.style.backgroundColor = '#16a34a';
                btn.style.color = 'white';
            } else if (btn.innerText.includes('Entregado')) {
                // Remove card or change style
                btn.closest('.order-card').style.opacity = '0.5';
                btn.disabled = true;
            } else {
                btn.innerText = 'ğŸš€ En Camino';
                btn.style.backgroundColor = '#dcfce7';
                btn.style.color = '#166534';
            }
        }
    </script>
</body>
</html>